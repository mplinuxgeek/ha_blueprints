blueprint:
  name: SigEnergy Solar Import & Export Control
  source_url: https://github.com/mplinuxgeek/ha_blueprints/blob/main/sigenergy_optimiser/sigenergy_optimiser.yaml
  description: |
    # SigEnergy Solar Import & Export Control

    Intelligent battery-preserving controller for SigEnergy EMS that prioritizes having enough battery to reach sunrise, avoids paid energy where possible, and earns from export/import opportunities without taking losses.

    ## Required helpers (create before use)
    - input_boolean: `input_boolean.sigenergy_automated_export`
    - input_number: `input_number.sigenergy_export_session_start_kwh`
    - input_number: `input_number.sigenergy_import_session_start_kwh`
    - input_text: `input_text.sigenergy_last_export_notification`
    - input_text: `input_text.sigenergy_last_import_notification`
    - input_text: `input_text.sigenergy_reason`
    - switch: `switch.sigen_plant_remote_ems_controled_by_home_assistant` (enables HA control)

    ## Battery protection (Priority #1)
    - Dynamic sunrise calculation: estimates SoC needed based on current load until sunrise + buffer
    - Sunrise target equals calculated need with a reserve floor (can be relaxed for export)
    - Day reserve: configurable minimum SoC floor during daytime
    - Always preserve overnight capacity before exporting
    - At night on battery-only (no import/export), stays in Maximum Self Consumption and caps PV max power to 0.1 kW to avoid unintended grid import

    ## Export profit maximization (Priority #2)
    - Tiered export limits scaling with FIT between low/medium/high thresholds
    - SoC-based scaling: gradual ramp-up as battery fills above required sunrise level
    - EMS hysteresis: uses start/stop around the low FIT threshold to prevent flapping
    - PCS limits: follow export/import limits directly
    - Mode: Command Discharging (PV First) - prioritizes solar over battery

    ## Import optimization
    - Negative-price import: tiered limits at low/medium/high negative thresholds
    - No SoC scaling on negative prices: charge at full tier rate when being paid
    - Smart top-up: gentle charge at very low prices, with forecast-aware daytime gating
    - Mode: Command Charging (Grid First) for negative prices, (PV First) for cheap top-up
    - PCS limits: follow export/import limits directly

    ## Anti-flapping & stability
    - Price hysteresis on mode switching
    - SoC hysteresis buffer for mode decisions
    - Minimum change thresholds to update limits
    - Notification deduplication: prevents spam when at limits
    - Session tracking: records kWh totals for export/import events

    ## Requirements
    - Never import or export when the price results in a loss
    - Avoid paid imports when possible; only import at very low prices or to protect the overnight reserve
    - Prefer value-positive export/import opportunities to offset fixed costs over time
    - Before late morning, hold charging by switching to Command Discharging (PV First) when PV forecast is high and negative prices are expected; keeps serving load from PV/battery without grid import unless prices are already sufficiently negative
    - Defaults are prefilled for a standard SigEnergy + Amber/Solcast setup; override if your entity IDs differ
    - Charge holdoff can be disabled via the “Enable Charge Holdoff” toggle if you want to bypass forecast-based morning holdoff

    ## Example config
    ```yaml
    description: ""
    alias: SigEnergy Solar Import & Export Control
    use_blueprint:
      path: mplinuxgeek/sigenergy_optimiser.yaml
      input:
        notification_service: notify.home_users
        ha_control_switch: switch.sigen_plant_remote_ems_controled_by_home_assistant
        grid_export_limit: number.sigen_plant_grid_export_limitation
        grid_import_limit: number.sigen_plant_grid_import_limitation
        pcs_export_limit: number.sigen_plant_pcs_export_limitation
        pcs_import_limit: number.sigen_plant_pcs_import_limitation
        export_session_start: input_number.sigenergy_export_session_start_kwh
        import_session_start: input_number.sigenergy_import_session_start_kwh
        last_export_notification: input_text.sigenergy_last_export_notification
        last_import_notification: input_text.sigenergy_last_import_notification
        pv_power_sensor: sensor.sigen_plant_pv_power
        consumed_power_sensor: sensor.sigen_plant_consumed_power
        battery_soc_sensor: sensor.sigen_plant_battery_state_of_charge
        ems_mode_select: select.sigen_plant_remote_ems_control_mode
        automated_export_flag: input_boolean.sigenergy_automated_export
        rated_capacity_sensor: sensor.sigen_plant_rated_energy_capacity
        available_discharge_sensor: sensor.sigen_plant_available_max_discharging_capacity
        price_sensor: sensor.amber_general_price
        feedin_sensor: sensor.amber_feed_in_price
        forecast_remaining_sensor: sensor.solcast_pv_forecast_forecast_remaining_today
        forecast_today_sensor: sensor.solcast_pv_forecast_forecast_today
        price_forecast_sensor: sensor.amber_general_forecast
        daily_export_energy: sensor.sigen_plant_daily_grid_export_energy
        daily_import_energy: sensor.sigen_plant_daily_grid_import_energy
        pv_max_power_limit: number.sigen_plant_pv_max_power_limit
        pv_max_power_normal: 25
        reason_text_helper: input_text.sigenergy_reason
        export_threshold_low: 0.1
        export_threshold_medium: 0.2
        export_threshold_high: 1.0
        import_threshold_low: 0.0
        import_threshold_medium: -0.15
        import_threshold_high: -0.3
        export_threshold_low: 0.1
        export_threshold_medium: 0.2
        export_threshold_high: 1.0
        import_threshold_low: 0.0
        import_threshold_medium: -0.15
        import_threshold_high: -0.3
    ```
  domain: automation
  input:
    control_notifications:
      name: |
        # Control & Notifications
      description: Primary control toggles and notification target.
      icon: mdi:bell-ring
      collapsed: true
      input:
        notification_service:
          name: Notification Service
          description: Notify service name (e.g., `notify.home_users` or `notify.mobile_app_pixel_8`). Enter the service string; leave blank to disable notifications.
          default: ""
          selector:
            text:
        auto_enable_ha_control:
          name: Auto-enable HA Control
          description: Turn on the EMS HA control switch automatically when needed.
          default: true
          selector:
            boolean: {}
        notify_daily_summary:
          name: Send Daily Summary
          description: Toggle to send the nightly summary notification at 23:50.
          default: true
          selector:
            boolean: {}
        daily_summary_time:
          name: Daily Summary Time
          description: Time to send the nightly summary.
          default: "23:55:00"
          selector:
            time: {}
        notify_morning_summary:
          name: Send Morning PV Forecast
          description: Toggle to send the morning PV forecast notification.
          default: true
          selector:
            boolean: {}
        morning_summary_time:
          name: Morning PV Forecast Time
          description: Time to send the morning PV forecast notification.
          default: "07:30:00"
          selector:
            time: {}
        automated_export_flag:
          name: Automated Export Flag
          description: Input boolean to enable/disable automated export (default `input_boolean.sigenergy_automated_export`).
          default: input_boolean.sigenergy_automated_export
          selector:
            entity:
              domain: input_boolean

    session_tracking:
      name: |
        # Session Tracking & Notification State
      description: Helpers for kWh session tracking and notification deduplication.
      icon: mdi:counter
      collapsed: true
      input:
        export_session_start:
          name: Export Session Start kWh
          description: Input number storing export session start kWh (default `input_number.sigenergy_export_session_start_kwh`).
          default: input_number.sigenergy_export_session_start_kwh
          selector:
            entity:
              domain: input_number
        import_session_start:
          name: Import Session Start kWh
          description: Input number storing import session start kWh (default `input_number.sigenergy_import_session_start_kwh`).
          default: input_number.sigenergy_import_session_start_kwh
          selector:
            entity:
              domain: input_number
        last_export_notification:
          name: Last Export Notification State
          description: Input text used to deduplicate export notifications (default `input_text.sigenergy_last_export_notification`).
          default: input_text.sigenergy_last_export_notification
          selector:
            entity:
              domain: input_text
        last_import_notification:
          name: Last Import Notification State
          description: Input text used to deduplicate import notifications (default `input_text.sigenergy_last_import_notification`).
          default: input_text.sigenergy_last_import_notification
          selector:
            entity:
              domain: input_text
        reason_text_helper:
          name: Reason Text Helper
          description: Input text to store the latest decision reason (default `input_text.sigenergy_reason`).
          default: input_text.sigenergy_reason
          selector:
            entity:
              domain: input_text

    ems_limits:
      name: |
        # EMS Control & Limits
      description: Entities used to switch EMS modes and set import/export limits.
      icon: mdi:transmission-tower-export
      collapsed: true
      input:
        ha_control_switch:
          name: HA Control Switch
          description: Switch that grants HA control of the EMS (default `switch.sigen_plant_remote_ems_controled_by_home_assistant`).
          default: switch.sigen_plant_remote_ems_controled_by_home_assistant
          selector:
            entity:
              domain: switch
        ems_mode_select:
          name: EMS Control Mode Select
          description: Select entity to set EMS operating mode (default `select.sigen_plant_remote_ems_control_mode`).
          default: select.sigen_plant_remote_ems_control_mode
          selector:
            entity:
              domain: select
        grid_export_limit:
          name: Grid Export Limitation
          description: Number entity for grid export limit (default `number.sigen_plant_grid_export_limitation`).
          default: number.sigen_plant_grid_export_limitation
          selector:
            entity:
              domain: number
        grid_import_limit:
          name: Grid Import Limitation
          description: Number entity for grid import limit (default `number.sigen_plant_grid_import_limitation`).
          default: number.sigen_plant_grid_import_limitation
          selector:
            entity:
              domain: number
        pv_max_power_limit:
          name: PV Max Power Limit
          description: PV max power limit number entity (default `number.sigen_plant_pv_max_power_limit`).
          default: number.sigen_plant_pv_max_power_limit
          selector:
            entity:
              domain: number
        pcs_export_limit:
          name: PCS Export Limitation
          description: PCS export limit number entity (default `number.sigen_plant_pcs_export_limitation`).
          default: number.sigen_plant_pcs_export_limitation
          selector:
            entity:
              domain: number
        pcs_import_limit:
          name: PCS Import Limitation
          description: PCS import limit number entity (default `number.sigen_plant_pcs_import_limitation`).
          default: number.sigen_plant_pcs_import_limitation
          selector:
            entity:
              domain: number
        ess_max_charging_limit:
          name: ESS Max Charging Limit (Optional)
          description: Number entity that caps ESS/grid charging power. Set to allow full-rate imports when price is negative.
          default: ""
          selector:
            entity:
              domain: number
        ess_max_discharging_limit:
          name: ESS Max Discharging Limit (Optional)
          description: Number entity that caps ESS discharging power. Set to export cap when exporting, very low when importing.
          default: ""
          selector:
            entity:
              domain: number

    sigenergy_sensors:
      name: |
        # SigEnergy Sensors
      description: Core PV/battery sensors and daily grid energy totals.
      icon: mdi:solar-power-variant
      collapsed: true
      input:
        pv_power_sensor:
          name: PV Power Sensor
          description: PV power sensor in Watts (default `sensor.sigen_plant_pv_power`).
          default: sensor.sigen_plant_pv_power
          selector:
            entity:
              domain: sensor
              device_class: power
        consumed_power_sensor:
          name: Consumed Power Sensor
          description: Home load/consumption power sensor in Watts (default `sensor.sigen_plant_consumed_power`).
          default: sensor.sigen_plant_consumed_power
          selector:
            entity:
              domain: sensor
              device_class: power
        battery_soc_sensor:
          name: Battery SoC Sensor
          description: Battery state-of-charge percentage sensor (default `sensor.sigen_plant_battery_state_of_charge`).
          default: sensor.sigen_plant_battery_state_of_charge
          selector:
            entity:
              domain: sensor
        rated_capacity_sensor:
          name: Rated Energy Capacity Sensor
          description: Battery rated capacity sensor (Wh or kWh, default `sensor.sigen_plant_rated_energy_capacity`).
          default: sensor.sigen_plant_rated_energy_capacity
          selector:
            entity:
              domain: sensor
              device_class: energy
        available_discharge_sensor:
          name: Available Discharge Energy Sensor
          description: Available discharge energy sensor in kWh (default `sensor.sigen_plant_available_max_discharging_capacity`).
          default: sensor.sigen_plant_available_max_discharging_capacity
          selector:
            entity:
              domain: sensor
              device_class: energy
        sun_entity:
          name: Sun Entity
          description: Sun entity for elevation and sunrise/sunset timings (default `sun.sun`).
          default: sun.sun
          selector:
            entity:
              domain: sun

        daily_export_energy:
          name: Daily Grid Export Energy
          description: Daily export energy sensor in kWh (default `sensor.sigen_plant_daily_grid_export_energy`).
          default: sensor.sigen_plant_daily_grid_export_energy
          selector:
            entity:
              domain: sensor
              device_class: energy
        daily_import_energy:
          name: Daily Grid Import Energy
          description: Daily import energy sensor in kWh (default `sensor.sigen_plant_daily_grid_import_energy`).
          default: sensor.sigen_plant_daily_grid_import_energy
          selector:
            entity:
              domain: sensor
              device_class: energy
        daily_load_energy:
          name: Daily Load Energy
          description: Home load/consumption energy kWh (default `sensor.sigen_plant_daily_load_consumption`).
          default: sensor.sigen_plant_daily_load_consumption
          selector:
            entity:
              domain: sensor
              device_class: energy
        daily_battery_charge_energy:
          name: Daily Battery Charge Energy
          description: Battery charge energy kWh (default `sensor.sigen_plant_daily_battery_charge_energy`).
          default: sensor.sigen_plant_daily_battery_charge_energy
          selector:
            entity:
              domain: sensor
              device_class: energy
        daily_battery_discharge_energy:
          name: Daily Battery Discharge Energy
          description: Battery discharge energy kWh (default `sensor.sigen_plant_daily_battery_discharge_energy`).
          default: sensor.sigen_plant_daily_battery_discharge_energy
          selector:
            entity:
              domain: sensor
              device_class: energy
        daily_pv_energy:
          name: Daily PV Energy
          description: PV generation energy kWh (default `sensor.sigen_plant_daily_pv_energy`).
          default: sensor.sigen_plant_daily_pv_energy
          selector:
            entity:
              domain: sensor
              device_class: energy

    price_forecast:
      name: |
        # Price & Forecast Sensors
      description: Price sensors and PV/price forecasts.
      icon: mdi:chart-multiline
      collapsed: true
      input:
        price_sensor:
          name: Buy Price Sensor
          description: Current buy price sensor (default `sensor.amber_general_price`).
          default: sensor.amber_general_price
          selector:
            entity:
              domain: sensor
        solar_power_now_sensor:
          name: PV Forecast Power Now
          description: PV power now estimate (e.g., `sensor.solcast_pv_forecast_power_now`) to confirm generation potential.
          default: sensor.solcast_pv_forecast_power_now
          selector:
            entity:
              domain: sensor
        feedin_sensor:
          name: Feed-in Price Sensor
          description: Feed-in tariff sensor (default `sensor.amber_feed_in_price`).
          default: sensor.amber_feed_in_price
          selector:
            entity:
              domain: sensor
        price_forecast_sensor:
          name: Price Forecast Sensor
          description: Price forecast sensor with `forecasts` attribute (default `sensor.amber_general_forecast`).
          default: sensor.amber_general_forecast
          selector:
            entity:
              domain: sensor
        forecast_remaining_sensor:
          name: PV Forecast Remaining (Today)
          description: Remaining PV forecast for today in kWh (default `sensor.solcast_pv_forecast_forecast_remaining_today`).
          default: sensor.solcast_pv_forecast_forecast_remaining_today
          selector:
            entity:
              domain: sensor
        forecast_today_sensor:
          name: PV Forecast Today
          description: Total PV forecast for today in kWh (default `sensor.solcast_pv_forecast_forecast_today`).
          default: sensor.solcast_pv_forecast_forecast_today
          selector:
            entity:
              domain: sensor

    export_pricing:
      name: |
        # Export Pricing & Caps
      description: Feed-in price tiers and **export power caps to the grid after house load is served**. If the cap is 7 kW and your load is 5 kW, only ~2 kW will export.
      icon: mdi:solar-power
      collapsed: false
      input:
        export_threshold_low:
          name: Export Threshold Low FIT Price
          description: Feed-in price ($/kWh) where export starts at the low tier.
          default: 0.10
          selector:
            number:
              min: -1
              max: 5
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        export_threshold_medium:
          name: Export Threshold Medium FIT Price
          description: Feed-in price ($/kWh) for medium export tier.
          default: 0.20
          selector:
            number:
              min: -1
              max: 5
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        export_threshold_high:
          name: Export Threshold High FIT Price
          description: Feed-in price ($/kWh) for full/high export tier.
          default: 1.00
          selector:
            number:
              min: 0
              max: 5
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        export_spike_threshold:
          name: Export FIT Spike Price
          description: Feed-in price ($/kWh) above which export is fully uncapped to the high limit (maximise earnings).
          default: 3.0
          selector:
            number:
              min: 0
              max: 100
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        export_limit_low:
          name: Export Limit Low
          description: Export power cap (kW) when feed-in price is at the low tier (grid export after serving your load).
          default: 5
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        export_limit_medium:
          name: Export Limit Medium
          description: Export power cap (kW) when feed-in price is at the medium tier (grid export after serving your load).
          default: 12
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        export_limit_high:
          name: Export Limit High
          description: Export power cap (kW) when feed-in price is at the high tier (grid export after serving your load).
          default: 25
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box

    import_pricing:
      name: |
        # Import Pricing & Caps
      description: Negative-price thresholds and import power caps.
      icon: mdi:transmission-tower-import
      collapsed: false
      input:
        import_threshold_low:
          name: Import Threshold Low
          description: Negative/low price ($/kWh) to begin importing.
          default: 0.0
          selector:
            number:
              min: -5
              max: 1
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        import_threshold_medium:
          name: Import Threshold Medium
          description: More negative price ($/kWh) for medium import limit.
          default: -0.15
          selector:
            number:
              min: -5
              max: 1
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        import_threshold_high:
          name: Import Threshold High
          description: Most negative price ($/kWh) for full/high import limit.
          default: -0.30
          selector:
            number:
              min: -5
              max: 1
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        import_limit_low:
          name: Import Limit Low
          description: Import power cap (kW) at the low negative-price tier.
          default: 30
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        import_limit_medium:
          name: Import Limit Medium
          description: Import power cap (kW) at the medium negative-price tier.
          default: 30
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        import_limit_high:
          name: Import Limit High
          description: Import power cap (kW) at the high/most negative price tier.
          default: 30
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box

    soc_reserves:
      name: |
        # SoC Floors & Reserves
      description: Reserve levels and buffers for protecting overnight capacity.
      icon: mdi:battery-plus-outline
      collapsed: true
      input:
        min_soc_floor:
          name: Minimum SoC Floor
          description: Minimum daytime battery SoC to maintain.
          default: 20
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        night_reserve_soc:
          name: Night Reserve SoC
          description: Minimum SoC to keep for overnight coverage.
          default: 30
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        night_reserve_buffer:
          name: Night Reserve Buffer
          description: Extra SoC buffer (%) added on top of the night reserve.
          default: 10
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        max_battery_soc:
          name: Max Battery SoC (Paid Import Cap)
          description: Upper SoC limit when performing paid imports.
          default: 50
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        sunrise_reserve_soc:
          name: Sunrise Reserve SoC
          description: Desired SoC at sunrise for overnight protection.
          default: 10
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        sunrise_safety_factor:
          name: Sunrise Safety Factor
          description: Multiplier on estimated overnight consumption to ensure margin.
          default: 1.0
          selector:
            number:
              min: 0.5
              max: 3
              step: 0.01
              mode: box
        sunrise_buffer_percent:
          name: Sunrise Buffer Percent
          description: Additional SoC buffer (%) added to the sunrise target.
          default: 0
          selector:
            number:
              min: 0
              max: 50
              step: 1
              unit_of_measurement: "%"
              mode: box
        sunrise_export_relax_percent:
          name: Sunrise Export Relax Percent
          description: How much the sunrise target can be relaxed for export during evening/night.
          default: 12
          selector:
            number:
              min: 0
              max: 50
              step: 1
              unit_of_measurement: "%"
              mode: box

    import_topup:
      name: |
        # Cheap Import Top Up
      description: Discretionary cheap-import rules and daytime top-up targets.
      icon: mdi:battery-charging
      collapsed: true
      input:
        max_price_threshold:
          name: Cheap Import Price Threshold
          description: Highest buy price ($/kWh) allowed for discretionary imports and daytime top-ups.
          default: 0.015
          selector:
            number:
              min: -1
              max: 1
              step: 0.001
              unit_of_measurement: $/kWh
              mode: box
        target_battery_charge:
          name: Target Battery Charge (kW)
          description: Target charging power when topping up from grid.
          default: 2
          selector:
            number:
              min: 0
              max: 20
              step: 0.1
              unit_of_measurement: kW
              mode: box
        cap_total_import:
          name: Max Total Import
          description: Overall import power cap (kW) after thresholds.
          default: 30
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        pv_max_power_normal:
          name: PV Max Power Limit (Normal)
          description: PV max power limit (kW) to restore when not forcing battery-only discharge.
          default: 25
          selector:
            number:
              min: 0
              max: 50
              step: 0.1
              unit_of_measurement: kW
              mode: box
        daytime_topup_max_soc:
          name: Daytime Top-up Max SoC
          description: Maximum SoC allowed for daytime top-up charging.
          default: 50
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box

    forecast_holdoff:
      name: |
        # Forecast-based Holdoff
      description: Settings for morning charge holdoff using forecasts.
      icon: mdi:weather-sunset
      collapsed: true
      input:
        standby_holdoff_enabled:
          name: Enable Charge Holdoff
          description: Toggle to enable/disable the morning charge holdoff logic.
          default: true
          selector:
            boolean: {}
        slow_charge_holdoff:
          name: Hold Off Slow Charge
          description: When holdoff is active, cap PV charge to a slow rate instead of full power.
          default: false
          selector:
            boolean: {}
        slow_charge_limit_kw:
          name: Slow Charge Limit
          description: PV charge cap (kW) to apply during holdoff when slow charge is enabled.
          default: 2
          selector:
            number:
              min: 0
              max: 20
              step: 0.1
              unit_of_measurement: kW
              mode: box
        pv_forecast_holdoff_kwh:
          name: PV Forecast Holdoff (kWh)
          description: PV forecast (kWh) that triggers the morning holdoff on charging.
          default: 120
          selector:
            number:
              min: 0
              max: 1000
              step: 1
              unit_of_measurement: kWh
              mode: box
        negative_price_forecast_lookahead_hours:
          name: Negative Price Forecast Lookahead (hours)
          description: Hours to look ahead in the price forecast for negative pricing.
          default: 12
          selector:
            number:
              min: 1
              max: 48
              step: 1
              unit_of_measurement: h
              mode: box
        standby_holdoff_end_time:
          name: Standby Holdoff End Time
          description: End time for the morning charge holdoff window.
          default: "11:00:00"
          selector:
            time: {}

    stability_hysteresis:
      name: |
        # Stability & Hysteresis
      description: Buffers and thresholds to reduce flapping and oscillation.
      icon: mdi:tune-vertical
      collapsed: true
      input:
        soc_hysteresis:
          name: SoC Hysteresis
          description: SoC buffer (%) to prevent rapid mode flapping.
          default: 3
          selector:
            number:
              min: 0
              max: 20
              step: 1
              unit_of_measurement: "%"
              mode: box
        min_change_threshold:
          name: Min Change Threshold (kW)
          description: Minimum delta (kW) before updating import/export limits.
          default: 0.15
          selector:
            number:
              min: 0
              max: 5
              step: 0.05
              unit_of_measurement: kW
              mode: box
        min_grid_transfer_kw:
          name: Min Grid Transfer (kW)
          description: Minimum grid transfer to avoid oscillation when near zero flow.
          default: 0.5
          selector:
            number:
              min: 0
              max: 5
              step: 0.1
              unit_of_measurement: kW
              mode: box
        export_hysteresis_percent:
          name: Export Hysteresis Percent
          description: Multiplier applied to stop export after start threshold to reduce flapping.
          default: 0.9
          selector:
            number:
              min: 0.5
              max: 1
              step: 0.01
              mode: box
        price_hysteresis:
          name: Price Hysteresis
          description: Price buffer ($/kWh) before changing modes/limits.
          default: 0.02
          selector:
            number:
              min: 0
              max: 1
              step: 0.01
              unit_of_measurement: $/kWh
              mode: box
        forecast_safety_margin:
          name: Forecast Safety Margin
          description: Multiplier on forecast need to keep a safety buffer.
          default: 1.2
          selector:
            number:
              min: 1
              max: 3
              step: 0.1
              mode: box
        export_soc_span_day:
          name: Export SoC Span Day
          description: SoC span (%) used for daytime export scaling.
          default: 20
          selector:
            number:
              min: 1
              max: 100
              step: 1
              unit_of_measurement: "%"
              mode: box
        sun_elevation_evening_threshold:
          name: Sun Elevation Evening Threshold
          description: Sun elevation (degrees) that marks evening/night for logic.
          default: 10
          selector:
            number:
              min: -90
              max: 90
              step: 1
              unit_of_measurement: "deg"
              mode: box

trigger:
  - platform: state
    entity_id:
      - !input pv_power_sensor
      - !input consumed_power_sensor
      - !input battery_soc_sensor
      - !input price_sensor
      - !input feedin_sensor
      - !input forecast_remaining_sensor
      - !input forecast_today_sensor
      - !input daily_export_energy
      - !input daily_import_energy
      - !input sun_entity
      - !input price_forecast_sensor
  - platform: time
    at: !input daily_summary_time
    id: daily_summary
  - platform: time
    at: !input morning_summary_time
    id: morning_summary
  - platform: homeassistant
    event: start
  - platform: time_pattern
    minutes: "/5"

condition: []

action:
  - variables:
      notification_service: !input notification_service
      notification_available: "{{ notification_service is not none and notification_service != '' }}"
      auto_enable_ha_control: !input auto_enable_ha_control
      notify_daily_summary: !input notify_daily_summary
      daily_summary_time: !input daily_summary_time
      notify_morning_summary: !input notify_morning_summary
      morning_summary_time: !input morning_summary_time
      slow_charge_holdoff: !input slow_charge_holdoff
      slow_charge_limit_kw: !input slow_charge_limit_kw
      export_threshold_low: !input export_threshold_low
      export_threshold_medium: !input export_threshold_medium
      export_threshold_high: !input export_threshold_high
      export_limit_low: !input export_limit_low
      export_limit_medium: !input export_limit_medium
      export_limit_high: !input export_limit_high
      export_spike_threshold: !input export_spike_threshold
      import_threshold_low: !input import_threshold_low
      import_threshold_medium: !input import_threshold_medium
      import_threshold_high: !input import_threshold_high
      import_limit_low: !input import_limit_low
      import_limit_medium: !input import_limit_medium
      import_limit_high: !input import_limit_high
      min_soc_floor: !input min_soc_floor
      night_reserve_soc: !input night_reserve_soc
      night_reserve_buffer: !input night_reserve_buffer
      max_battery_soc: !input max_battery_soc
      sunrise_reserve_soc: !input sunrise_reserve_soc
      sunrise_safety_factor: !input sunrise_safety_factor
      sunrise_buffer_percent: !input sunrise_buffer_percent
      sunrise_export_relax_percent: !input sunrise_export_relax_percent
      max_price_threshold: !input max_price_threshold
      target_battery_charge: !input target_battery_charge
      cap_total_import: !input cap_total_import
      pv_max_power_normal: !input pv_max_power_normal
      daytime_topup_max_soc: !input daytime_topup_max_soc
      standby_holdoff_enabled: !input standby_holdoff_enabled
      pv_forecast_holdoff_kwh: !input pv_forecast_holdoff_kwh
      negative_price_forecast_lookahead_hours: !input negative_price_forecast_lookahead_hours
      standby_holdoff_end_time: !input standby_holdoff_end_time
      soc_hysteresis: !input soc_hysteresis
      min_change_threshold: !input min_change_threshold
      min_grid_transfer_kw: !input min_grid_transfer_kw
      export_hysteresis_percent: !input export_hysteresis_percent
      price_hysteresis: !input price_hysteresis
      forecast_safety_margin: !input forecast_safety_margin
      export_soc_span_day: !input export_soc_span_day
      sun_elevation_evening_threshold: !input sun_elevation_evening_threshold

      pv_power_sensor_entity: !input pv_power_sensor
      consumed_power_sensor_entity: !input consumed_power_sensor
      battery_soc_sensor_entity: !input battery_soc_sensor
      sun_entity_id: !input sun_entity
      price_sensor_entity: !input price_sensor
      feedin_sensor_entity: !input feedin_sensor
      ems_mode_select_entity: !input ems_mode_select
      grid_export_limit_entity: !input grid_export_limit
      grid_import_limit_entity: !input grid_import_limit
      pv_max_power_limit_entity: !input pv_max_power_limit
      pcs_export_limit_entity: !input pcs_export_limit
      pcs_import_limit_entity: !input pcs_import_limit
      ess_max_charging_limit_entity: !input ess_max_charging_limit
      ess_max_discharging_limit_entity: !input ess_max_discharging_limit
      forecast_remaining_sensor_entity: !input forecast_remaining_sensor
      forecast_today_sensor_entity: !input forecast_today_sensor
      solar_power_now_sensor_entity: !input solar_power_now_sensor
      available_discharge_sensor_entity: !input available_discharge_sensor
      ha_control_switch_entity: !input ha_control_switch
      price_forecast_sensor_entity: !input price_forecast_sensor
      rated_capacity_sensor_entity: !input rated_capacity_sensor
      daily_export_energy_entity: !input daily_export_energy
      export_session_start_entity: !input export_session_start
      daily_import_energy_entity: !input daily_import_energy
      import_session_start_entity: !input import_session_start
      daily_load_energy_entity: !input daily_load_energy
      daily_battery_charge_energy_entity: !input daily_battery_charge_energy
      daily_battery_discharge_energy_entity: !input daily_battery_discharge_energy
      daily_pv_energy_entity: !input daily_pv_energy
      last_export_notification_entity: !input last_export_notification
      last_import_notification_entity: !input last_import_notification
      reason_text_entity: !input reason_text_helper

      pv_power: "{{ states(pv_power_sensor_entity) | float(0) }}"
      consumed_power: "{{ states(consumed_power_sensor_entity) | float(0) }}"
      battery_soc_raw: "{{ states(battery_soc_sensor_entity) | float(0) }}"
      battery_soc: "{{ [0, [battery_soc_raw, 100] | min] | max }}"
      sun_elevation: "{{ state_attr(sun_entity_id, 'elevation') | float(0) }}"
      price_state: "{{ states(price_sensor_entity) }}"
      price_valid: "{{ price_state not in ['unknown','unavailable','none',''] }}"
      current_price: "{{ price_state | float(999) if price_valid else 999 }}"
      feedin_price: "{{ states(feedin_sensor_entity) | float(-999) }}"
      export_spike_active: "{{ feedin_price >= (export_spike_threshold | float(0)) }}"
      solar_power_now: "{{ states(solar_power_now_sensor_entity) | float(0) }}"
      current_mode: "{{ states(ems_mode_select_entity) }}"
      current_export_limit: "{{ states(grid_export_limit_entity) | float(0) }}"
      current_import_limit: "{{ states(grid_import_limit_entity) | float(0) }}"
      current_pv_max_power_limit: "{{ states(pv_max_power_limit_entity) | float(0) }}"
      current_pcs_export_limit: "{{ states(pcs_export_limit_entity) | float(0) }}"
      current_pcs_import_limit: "{{ states(pcs_import_limit_entity) | float(0) }}"
      forecast_remaining: "{{ states(forecast_remaining_sensor_entity) | float(0) }}"
      forecast_today: "{{ states(forecast_today_sensor_entity) | float(0) }}"
      available_discharge_energy: "{{ states(available_discharge_sensor_entity) | float(0) }}"
      ha_control_enabled: "{{ is_state(ha_control_switch_entity, 'on') }}"
      pv_kw: "{{ (pv_power | float(0)) / (1000 if (pv_power | float(0)) > 1000 else 1) }}"
      load_kw: "{{ (consumed_power | float(0)) / (1000 if (consumed_power | float(0)) > 1000 else 1) }}"
      solar_power_now_kw: "{{ (solar_power_now | float(0)) / 1000 }}"
      solar_potential_kw: "{{ [pv_kw, solar_power_now_kw] | max }}"
      battery_capacity_kwh: >
        {% set cap_raw = states(rated_capacity_sensor_entity) | float(0) %}
        {% set cap_uom = state_attr(rated_capacity_sensor_entity,'unit_of_measurement') %}
        {% set uom = cap_uom | lower if cap_uom is string else '' %}
        {% set cap_kwh = cap_raw if 'kwh' in uom else (cap_raw / 1000 if 'wh' in uom else cap_raw) %}
        {{ cap_kwh if cap_kwh > 0 else 0.001 }}
      battery_fill_need_kwh: >
        {% set need_unclamped = battery_capacity_kwh - (available_discharge_energy | float(0)) %}
        {{ [battery_capacity_kwh, [need_unclamped, 0] | max] | min }}

      negative_price_forecast_ahead: >
        {% set fc = state_attr(price_forecast_sensor_entity,'forecasts') %}
        {% if fc is not iterable %}
          {{ false }}
        {% else %}
          {% set ns = namespace(found=false) %}
          {% set now_ts = as_timestamp(now()) %}
          {% set cutoff = now_ts + (negative_price_forecast_lookahead_hours | float(12)) * 3600 %}
          {% for f in fc %}
            {% if f is mapping and 'per_kwh' in f and 'start_time' in f %}
              {% set ts = as_timestamp(f.start_time) %}
              {% if ts is not none and ts <= cutoff and (f.per_kwh | float(0)) < 0 %}
                {% set ns.found = true %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ ns.found }}
        {% endif %}
      negative_price_forecast_bool: "{{ negative_price_forecast_ahead | bool(false) }}"

      price_is_negative: "{{ price_valid and current_price < 0 }}"
      feedin_is_negative: "{{ feedin_price < 0 }}"
      is_evening_or_night: "{{ sun_elevation < sun_elevation_evening_threshold }}"
      morning_holdoff_window: "{{ standby_holdoff_enabled and negative_price_forecast_bool and now() < today_at(standby_holdoff_end_time) }}"

      battery_soc_required_to_sunrise: >
        {% set load_s = states(consumed_power_sensor_entity) %}
        {% set cap_s = states(rated_capacity_sensor_entity) %}
        {% set next_rising = state_attr(sun_entity_id,'next_rising') %}
        {% set next_setting = state_attr(sun_entity_id,'next_setting') %}
        {% if load_s in ['unknown','unavailable','none',''] or
              cap_s in ['unknown','unavailable','none',''] or
              next_rising is none or next_setting is none %}
          {{ night_reserve_soc + night_reserve_buffer }}
        {% else %}
          {% set load_kw = load_s | float(0) %}
          {% set cap_raw = cap_s | float(0) %}
          {% set cap_uom = state_attr(rated_capacity_sensor_entity,'unit_of_measurement') %}
          {% set cap_kwh = (cap_raw / 1000.0) if cap_uom in ['Wh','wH'] else cap_raw %}
          {% set target_ts = as_timestamp(next_rising) + 3600 %}
          {% set start_ts = as_timestamp(now()) if is_state(sun_entity_id,'below_horizon')
                          else as_timestamp(next_setting) %}
          {% set hours_left = (target_ts - start_ts) / 3600.0 %}
          {% if cap_kwh <= 0 or target_ts <= 0 or hours_left <= 0 %}
            {{ night_reserve_soc + night_reserve_buffer }}
          {% else %}
            {% set reserve_kwh = cap_kwh * (sunrise_reserve_soc / 100.0) %}
            {% set energy_needed_kwh = load_kw * hours_left * sunrise_safety_factor %}
            {% set required_soc = ((reserve_kwh + energy_needed_kwh) / cap_kwh) * 100.0 %}
            {{ [[required_soc, 100] | min, 0] | max }}
          {% endif %}
        {% endif %}

      sunrise_soc_target: >
        {% set base = battery_soc_required_to_sunrise | default(night_reserve_soc + night_reserve_buffer) %}
        {{ (base | float(0)) + (sunrise_buffer_percent | float(0)) }}

      hours_to_sunrise: >
        {% set next_rising = state_attr(sun_entity_id,'next_rising') %}
        {% if next_rising is none %}
          6
        {% else %}
          {% set target_ts = as_timestamp(next_rising) + 3600 %}
          {% set start_ts = as_timestamp(now()) %}
          {% set hours = (target_ts - start_ts) / 3600.0 %}
          {{ [hours, 0] | max }}
        {% endif %}

      effective_min_soc: >
        {% if is_evening_or_night %}
          {% set relaxed = (sunrise_soc_target | float(0)) - (sunrise_export_relax_percent | float(0)) %}
          {{ [[relaxed, 100] | min, sunrise_reserve_soc] | max }}
        {% else %}
          {{ min_soc_floor }}
        {% endif %}
      export_solar_override: >
        {{ feedin_price > 0
           and battery_soc >= max_battery_soc
           and not is_evening_or_night
           and (solar_potential_kw - load_kw) > (min_grid_transfer_kw | float(0.5)) }}

      standby_holdoff_active: >
        {% set cutoff = today_at(standby_holdoff_end_time) %}
        {{ standby_holdoff_enabled
           and forecast_today >= pv_forecast_holdoff_kwh
           and negative_price_forecast_ahead
           and now() < cutoff
           and current_price > import_threshold_low }}

      export_min_soc: >
        {{ effective_min_soc | float }}

      export_start_low: "{{ export_threshold_low }}"
      export_stop_low: "{{ export_threshold_low * export_hysteresis_percent }}"

      export_soc_span_dynamic: >
        {% if is_evening_or_night %}
          {% set span = ((hours_to_sunrise | float(6)) * consumed_power / battery_capacity_kwh) * 100 %}
          {{ [25, [span, 4] | max] | min }}
        {% else %}
          {{ export_soc_span_day }}
        {% endif %}

      export_tier_limit: >
        {% if export_spike_active | default(false) %}
          {{ export_limit_high }}
        {% elif export_solar_override %}
          {{ export_limit_high }}
        {% elif feedin_price < export_threshold_low %}
          0
        {% elif feedin_price >= export_threshold_high %}
          {{ export_limit_high }}
        {% elif feedin_price >= export_threshold_medium %}
          {% set frac = (feedin_price - export_threshold_medium) / (export_threshold_high - export_threshold_medium) %}
          {{ export_limit_medium + (frac * (export_limit_high - export_limit_medium)) }}
        {% else %}
          {% set frac = (feedin_price - export_threshold_low) / (export_threshold_medium - export_threshold_low) %}
          {{ export_limit_low + (frac * (export_limit_medium - export_limit_low)) }}
        {% endif %}

      export_blocked_for_forecast: >
        {% if is_evening_or_night %}
          {{ false }}
        {% else %}
          {{ forecast_remaining < (battery_fill_need_kwh * forecast_safety_margin) }}
        {% endif %}
      export_blocked_effective: >
        {{ export_blocked_for_forecast and not (export_solar_override or export_spike_active | default(false)) }}

      grid_limit_base: >
        {% if current_price <= max_price_threshold
              and current_price >= 0
              and battery_soc < max_battery_soc %}
          {% if forecast_today >= pv_forecast_holdoff_kwh
                and negative_price_forecast_ahead
                and battery_soc >= (sunrise_soc_target | float(0)) %}
            0
          {% elif is_evening_or_night %}
            {% if battery_soc < (sunrise_soc_target | float(0)) %}
              {% set target_total_kw = consumed_power + target_battery_charge %}
              {% set needed_from_grid_kw = target_total_kw - pv_power %}
              {{ [0, [needed_from_grid_kw, cap_total_import] | min] | max | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            {% if battery_soc < daytime_topup_max_soc
                  and current_price <= max_price_threshold
                  and forecast_remaining < (battery_fill_need_kwh * forecast_safety_margin) %}
              {% set target_total_kw = consumed_power + target_battery_charge %}
              {% set needed_from_grid_kw = target_total_kw - pv_power %}
              {{ [0, [needed_from_grid_kw, cap_total_import] | min] | max | round(1) }}
            {% else %}
              0
            {% endif %}
          {% endif %}
        {% else %}
          0
        {% endif %}

      import_limit_negative: >
        {% if price_is_negative %}
          {% if current_price <= import_threshold_high %}
            {% set requested_limit = import_limit_high %}
          {% elif current_price <= import_threshold_medium %}
            {% set requested_limit = import_limit_medium %}
          {% elif current_price <= import_threshold_low %}
            {% set requested_limit = import_limit_low %}
          {% else %}
            {% set requested_limit = 0 %}
          {% endif %}
          {{ [requested_limit, cap_total_import] | min }}
        {% else %}
          0
        {% endif %}

      desired_import_limit: >
        {% if standby_holdoff_active %}
          {% if battery_soc <= export_min_soc %}
            {% set limit = import_limit_low %}
          {% else %}
            {% set limit = 0 %}
          {% endif %}
        {% elif price_is_negative %}
          {% set limit = import_limit_negative %}
        {% elif feedin_price >= export_threshold_low %}
          {% set limit = 0 %}
        {% else %}
          {% set limit = grid_limit_base %}
        {% endif %}
        {% if current_price > max_price_threshold
              and battery_soc >= (sunrise_soc_target | float(0)) %}
          {% set limit = 0 %}
        {% endif %}
        {% set limit = [0, limit] | max | round(1) %}
        {% if limit < min_grid_transfer_kw %}
          0
        {% else %}
          {{ limit }}
        {% endif %}

      export_reason: >
        {% if price_is_negative or feedin_is_negative or export_blocked_effective %}
          Export blocked (price/forecast)
        {% elif battery_soc <= export_min_soc %}
          Export blocked (SoC below sunrise target)
        {% else %}
          {% set diff = battery_soc - export_min_soc %}
          {% set span = export_soc_span_dynamic %}
          {% set scale_soc = [1.0, [diff / span, 0] | max] | min %}
          {% set tier_cap = export_tier_limit | float(0) %}
          {% if tier_cap <= 0 %}
            Export blocked (price low)
          {% else %}
            {% if export_spike_active | default(false) %}
              Export spike (full export)
            {% elif export_solar_override %}
              Export override (exporting excess PV)
            {% else %}
              {% set hours = hours_to_sunrise | float(1) %}
              {% set hours_div = [hours, 2] | min %}
              {% set headroom_kwh = (diff / 100) * battery_capacity_kwh %}
              {% set safe_kw_base = headroom_kwh / [hours_div, 1] | max %}
              {% set boost = [2.0, 1 + ((tier_cap / export_limit_high) * 0.5)] | min %}
              {% set safe_kw = safe_kw_base * boost %}
              {% set safe_cap = [safe_kw, tier_cap] | min %}
              {% set raw_limit = tier_cap * scale_soc %}
              {% set final_limit = [raw_limit, safe_cap] | min %}
              {% if final_limit == 0 %}
                Export blocked (zero cap)
              {% elif final_limit == safe_cap %}
                Export limited (safe cap)
              {% elif final_limit == raw_limit %}
                Export limited (price/SoC)
              {% else %}
                Export limited (composite)
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}

      import_reason: >
        {% if standby_holdoff_active %}
          Import blocked (holdoff)
        {% elif not price_valid %}
          Import blocked (price unavailable)
        {% elif price_is_negative %}
          Importing (price is negative)
        {% elif feedin_price >= export_threshold_low %}
          Import blocked (FIT higher than buy)
        {% elif current_price > max_price_threshold and battery_soc >= (sunrise_soc_target | float(0)) %}
          Import blocked (price/SoC above cheap threshold)
        {% elif grid_limit_base <= 0 %}
          Import blocked (price not cheap enough or no top-up needed)
        {% elif desired_import_limit > 0 %}
          Import enabled {{ desired_import_limit }} kW
        {% else %}
          Import blocked (no condition)
        {% endif %}

      desired_export_limit: >
        {% if price_is_negative or feedin_is_negative or export_blocked_effective %}
          0
        {% elif battery_soc <= export_min_soc %}
          0
        {% else %}
          {% set diff = battery_soc - export_min_soc %}
          {% set span = export_soc_span_dynamic %}
          {% set scale_soc = [1.0, [diff / span, 0] | max] | min %}
          {% set tier_cap = export_tier_limit | float(0) %}
          {% if tier_cap <= 0 %}
            0
          {% else %}
            {% if export_spike_active | default(false) %}
              {{ [tier_cap, export_limit_high] | min | round(1) }}
            {% elif export_solar_override %}
              {% set excess_kw = [pv_kw - load_kw, solar_power_now_kw, 0] | max %}
              {% set override_cap = [excess_kw, export_limit_high] | min %}
              {% set limit = [0, override_cap] | max | round(1) %}
              {% if limit < min_grid_transfer_kw %}
                0
              {% else %}
                {{ limit }}
              {% endif %}
            {% else %}
              {% set hours = hours_to_sunrise | float(1) %}
              {% set hours_div = [hours, 2] | min %}
              {% set headroom_kwh = (diff / 100) * battery_capacity_kwh %}
              {% set safe_kw_base = headroom_kwh / [hours_div, 1] | max %}
              {% set boost = [2.0, 1 + ((tier_cap / export_limit_high) * 0.5)] | min %}
              {% set safe_kw = safe_kw_base * boost %}
              {% set safe_cap = [safe_kw, tier_cap] | min %}
              {% set raw_limit = tier_cap * scale_soc %}
              {% set final_limit = [raw_limit, safe_cap] | min %}
              {% set limit = [0, final_limit] | max | round(1) %}
              {% if limit < min_grid_transfer_kw %}
                0
              {% else %}
                {{ limit }}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}

      needs_ha_control_switch: >
        {{ auto_enable_ha_control and (not ha_control_enabled) and
           (feedin_is_negative or (desired_export_limit | float > 0) or (desired_import_limit | float > 0)
            or (current_mode != desired_ems_mode)) }}
      effective_ha_control_enabled: "{{ ha_control_enabled or needs_ha_control_switch }}"

      desired_ems_mode: >
        {% set currently_discharging = current_mode in
          ['Command Discharging (PV First)', 'Command Discharging (ESS First)'] %}
        {% set currently_charging = current_mode in ['Command Charging (PV First)', 'Command Charging (Grid First)'] %}
        {% if export_solar_override %}
          Maximum Self Consumption
        {% elif standby_holdoff_active and (desired_export_limit | float(0)) == 0 %}
          {% if battery_soc > (export_min_soc + soc_hysteresis) %}
            Command Discharging (ESS First)
          {% else %}
            Maximum Self Consumption
          {% endif %}
        {% elif price_is_negative and current_price <= import_threshold_low %}
          Command Charging (Grid First)
        {% elif feedin_is_negative %}
          Maximum Self Consumption
        {% elif desired_export_limit | float > 0 %}
          Command Discharging (PV First)
        {% elif (not export_blocked_for_forecast) and battery_soc > (export_min_soc + soc_hysteresis) %}
          {% if currently_discharging and feedin_price >= (export_stop_low | float) %}
            Command Discharging (PV First)
          {% elif feedin_price >= (export_start_low | float) %}
            Command Discharging (PV First)
          {% else %}
            Maximum Self Consumption
          {% endif %}
        {% elif grid_limit_base > 0 and feedin_price < (export_threshold_low - price_hysteresis) and battery_soc < (max_battery_soc - soc_hysteresis) %}
          Command Charging (PV First)
        {% elif currently_charging and grid_limit_base > 0 and feedin_price < (export_threshold_low + price_hysteresis) and battery_soc < max_battery_soc %}
          Command Charging (PV First)
        {% else %}
          Maximum Self Consumption
        {% endif %}

      battery_only_mode: >
        {{ desired_ems_mode == 'Maximum Self Consumption'
           and (desired_export_limit | float(0)) == 0
           and (desired_import_limit | float(0)) == 0
           and (is_evening_or_night or standby_holdoff_active) }}

      desired_pv_max_power_limit: >
        {% set slow_holdoff = slow_charge_holdoff | bool(false) %}
        {% if standby_holdoff_active and (desired_export_limit | float(0)) == 0 %}
          0.1
        {% elif battery_only_mode %}
          0.1
        {% elif morning_holdoff_window and slow_holdoff %}
          {% set load_kw = (consumed_power | float(0)) / 1000 %}
          {% set cap = load_kw + (slow_charge_limit_kw | float(2)) %}
          {% set cap = [cap, pv_max_power_normal | float(25)] | min %}
          {{ [cap, 0.1] | max }}
        {% else %}
          {{ pv_max_power_normal }}
        {% endif %}

      desired_ess_charge_limit: >
        {% if desired_import_limit | float(0) > 0 %}
          {{ [cap_total_import | float(30), import_limit_high | float(30), desired_import_limit | float(0)] | max }}
        {% else %}
          {{ cap_total_import | float(30) }}
        {% endif %}

      desired_ess_discharge_limit: >
        {% if standby_holdoff_active and (desired_export_limit | float(0)) == 0 %}
          {% set cover_load = [load_kw, min_grid_transfer_kw | float(0.5)] | max %}
          {{ cover_load }}
        {% elif desired_export_limit | float(0) > 0 %}
          {{ desired_export_limit }}
        {% else %}
          0.1
        {% endif %}

      reason_should_log: >
        {% set export_diff = (desired_export_limit | float - current_export_limit) | abs %}
        {% set import_diff = (desired_import_limit | float - current_import_limit) | abs %}
        {% set pv_diff = (desired_pv_max_power_limit | float - current_pv_max_power_limit) | abs %}
        {% set mode_changed = (current_mode != desired_ems_mode) %}
        {{ (effective_ha_control_enabled and (export_diff >= min_change_threshold or import_diff >= min_change_threshold or mode_changed))
           or pv_diff > 0 }}

      outcome_reason: >
        {{ export_reason | default('n/a') }}; {{ import_reason | default('n/a') }}; PV Limit {{ (desired_pv_max_power_limit | default(pv_max_power_normal)) | round(1) }} kW

      daily_export_kwh: "{{ states(daily_export_energy_entity) | float(0) }}"
      export_session_start_kwh: "{{ states(export_session_start_entity) | float(0) }}"
      export_session_kwh: >
        {% set diff = daily_export_kwh - export_session_start_kwh %}
        {{ [diff, 0] | max | round(3) }}
      daily_import_kwh: "{{ states(daily_import_energy_entity) | float(0) }}"
      import_session_start_kwh: "{{ states(import_session_start_entity) | float(0) }}"
      import_session_kwh: >
        {% set diff = daily_import_kwh - import_session_start_kwh %}
        {{ [diff, 0] | max | round(3) }}
      daily_load_kwh: "{{ states(daily_load_energy_entity) | float(0) }}"
      daily_battery_charge_kwh: "{{ states(daily_battery_charge_energy_entity) | float(0) }}"
      daily_battery_discharge_kwh: "{{ states(daily_battery_discharge_energy_entity) | float(0) }}"
      daily_pv_kwh: "{{ states(daily_pv_energy_entity) | float(0) }}"
      last_export_notification_state: "{{ states(last_export_notification_entity) | default('stopped') }}"
      last_import_notification_state: "{{ states(last_import_notification_entity) | default('stopped') }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ needs_ha_control_switch }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input ha_control_switch

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_ha_control_enabled and current_mode != desired_ems_mode }}"
        sequence:
          - action: select.select_option
            target:
              entity_id: !input ems_mode_select
            data:
              option: "{{ desired_ems_mode }}"

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set diff = (desired_export_limit | float - current_export_limit) | abs %}
              {{ effective_ha_control_enabled and (diff >= (min_change_threshold | float) or 
                 (current_export_limit == 0 and desired_export_limit > 0) or
                 (current_export_limit > 0 and desired_export_limit == 0)) }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notification_available }}"
                  - condition: template
                    value_template: "{{ current_export_limit == 0 and desired_export_limit > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input ha_control_switch
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input automated_export_flag
                  - action: input_number.set_value
                    target:
                      entity_id: !input export_session_start
                    data:
                      value: "{{ daily_export_kwh }}"
                  - action: logbook.log
                    data:
                      name: "SigEnergy Export"
                      message: >
                        Export ENABLED → {{ desired_export_limit }} kW
                        FIT={{ feedin_price | round(3) }} $/kWh
                        SoC={{ battery_soc | round(0) }}%
                        Mode={{ desired_ems_mode }}
                      entity_id: !input grid_export_limit
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ last_export_notification_state != 'started' }}"
                        sequence:
                          - service: "{{ notification_service }}"
                            data:
                              title: "⚡ SigEnergy: Export Started"
                              message: |
                                💰 Earning ${{ feedin_price | round(3) }}/kWh
                                📤 Export Limit: {{ desired_export_limit }} kW
                                🔋 Battery: {{ battery_soc | round(0) }}% (Min {{ export_min_soc | round(0) }}%)
                                🧠 Mode: {{ desired_ems_mode }}
                                🌙 Night: {{ is_evening_or_night }}
                                ☀️ PV Remaining: {{ forecast_remaining | round(1) }} kWh
                          - service: input_text.set_value
                            target:
                              entity_id: !input last_export_notification
                            data:
                              value: "started"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ notification_available }}"
          - condition: template
            value_template: "{{ current_export_limit > 0 and desired_export_limit == 0 }}"
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input automated_export_flag
                    state: "on"
                sequence:
                  - action: logbook.log
                    data:
                      name: "SigEnergy Export"
                      message: >
                        Export DISABLED → Session {{ export_session_kwh }} kWh
                        FIT={{ feedin_price | round(3) }} $/kWh
                        SoC={{ battery_soc | round(0) }}%
                        Mode={{ desired_ems_mode }}
                      entity_id: !input grid_export_limit
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ last_export_notification_state != 'stopped' }}"
                sequence:
                  - service: "{{ notification_service }}"
                    data:
                      title: "🛑 SigEnergy: Export Stopped"
                      message: |
                        📤 Session Export: {{ export_session_kwh }} kWh
                        📈 Daily Total: {{ daily_export_kwh | round(3) }} kWh
                        🔋 Battery: {{ battery_soc | round(0) }}%
                        💲 FIT: {{ feedin_price | round(3) }} $/kWh
                        🧠 Mode: {{ desired_ems_mode }}
                  - service: input_text.set_value
                    target:
                      entity_id: !input last_export_notification
                    data:
                      value: "stopped"
          - service: input_boolean.turn_off
            target:
              entity_id: !input automated_export_flag

  - action: number.set_value
    target:
      entity_id: !input grid_export_limit
    data:
      value: >
        {% if desired_export_limit > 0 %}
          {{ desired_export_limit }}
        {% else %}
          0.01
        {% endif %}

  - action: number.set_value
    target:
      entity_id: !input pcs_export_limit
    data:
      value: >
        {% if desired_export_limit > 0 %}
          {{ desired_export_limit }}
        {% else %}
          0.01
        {% endif %}

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set diff = (desired_import_limit | float - current_import_limit) | abs %}
              {{ effective_ha_control_enabled and (diff >= (min_change_threshold | float) or
                 (current_import_limit == 0 and desired_import_limit > 0) or
                 (current_import_limit > 0 and desired_import_limit == 0)) }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notification_available }}"
                  - condition: template
                    value_template: "{{ current_import_limit == 0 and desired_import_limit > 0 }}"
                sequence:
                  - action: input_number.set_value
                    target:
                      entity_id: !input import_session_start
                    data:
                      value: "{{ daily_import_kwh }}"
                  - action: logbook.log
                    data:
                      name: "SigEnergy Import"
                      message: >
                        Import ENABLED → {{ desired_import_limit }} kW
                        Price={{ current_price }}
                      entity_id: !input grid_import_limit
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ last_import_notification_state != 'started' }}"
                        sequence:
                          - service: "{{ notification_service }}"
                            data:
                              title: "⚡ SigEnergy: Import Started"
                              message: >
                                💲 Price: {{ current_price | round(3) }} $/kWh
                                📥 Import Limit: {{ desired_import_limit }} kW
                                🔋 Battery: {{ battery_soc | round(0) }}%
                                🌙 Night: {{ is_evening_or_night }}
                          - service: input_text.set_value
                            target:
                              entity_id: !input last_import_notification
                            data:
                              value: "started"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notification_available }}"
                  - condition: template
                    value_template: "{{ current_import_limit > 0 and desired_import_limit == 0 }}"
                sequence:
                  - action: logbook.log
                    data:
                      name: "SigEnergy Import"
                      message: >
                        Import DISABLED → Session {{ import_session_kwh }} kWh
                        Last Limit={{ current_import_limit }} kW
                        Price={{ current_price }}
                      entity_id: !input grid_import_limit
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ last_import_notification_state != 'stopped' }}"
                        sequence:
                          - service: "{{ notification_service }}"
                            data:
                              title: "🛑 SigEnergy: Import Stopped"
                              message: |
                                📥 Session Import: {{ import_session_kwh }} kWh
                                📈 Daily Total: {{ daily_import_kwh | round(3) }} kWh
                                💲 Last seen price: ${{ current_price | round(3) }}/kWh
                                🔋 Battery: {{ battery_soc | round(0) }}%
                          - service: input_text.set_value
                            target:
                              entity_id: !input last_import_notification
                            data:
                              value: "stopped"
          - action: number.set_value
            target:
              entity_id: !input grid_import_limit
            data:
              value: >
                {% if desired_import_limit > 0 %}
                  {{ desired_import_limit }}
                {% else %}
                  0.01
                {% endif %}

  - action: number.set_value
    target:
      entity_id: !input pcs_import_limit
    data:
      value: >
        {% if desired_import_limit > 0 %}
          {{ desired_import_limit }}
        {% else %}
          0.01
        {% endif %}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_ha_control_enabled and ess_max_charging_limit_entity | default('') }}"
        sequence:
          - action: number.set_value
            target:
              entity_id: "{{ ess_max_charging_limit_entity }}"
            data:
              value: "{{ desired_ess_charge_limit }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_ha_control_enabled and ess_max_discharging_limit_entity | default('') }}"
        sequence:
          - action: number.set_value
            target:
              entity_id: "{{ ess_max_discharging_limit_entity }}"
            data:
              value: "{{ desired_ess_discharge_limit }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_ha_control_enabled and (current_pv_max_power_limit | float(0)) != (desired_pv_max_power_limit | float(0)) }}"
        sequence:
          - action: number.set_value
            target:
              entity_id: !input pv_max_power_limit
            data:
              value: "{{ desired_pv_max_power_limit }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger is defined and trigger.id == 'daily_summary' and notify_daily_summary and notification_available }}"
        sequence:
          - service: "{{ notification_service }}"
            data:
              title: "☀️ SigEnergy Summary"
              message: |
                🔌 Use: {{ daily_load_kwh | round(2) }} kWh
                ☀️ PV: {{ daily_pv_kwh | round(2) }} kWh
                🔋 Batt charge/discharge: +{{ daily_battery_charge_kwh | round(2) }} / -{{ daily_battery_discharge_kwh | round(2) }} kWh
                📥 Grid import: {{ daily_import_kwh | round(2) }} kWh
                📤 Grid export: {{ daily_export_kwh | round(2) }} kWh
                🔚 SoC: {{ battery_soc | round(0) }}%
      - conditions:
          - condition: template
            value_template: "{{ trigger is defined and trigger.id == 'morning_summary' and notify_morning_summary and notification_available }}"
        sequence:
          - service: "{{ notification_service }}"
            data:
              title: "🌅 SigEnergy Morning"
              message: |
                ☀️ PV forecast today: {{ forecast_today | round(1) }} kWh
                🔋 Batt discharge so far: {{ daily_battery_discharge_kwh | round(2) }} kWh
                🔚 SoC: {{ battery_soc | round(0) }}%

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ reason_should_log }}"
        sequence:
          - service: logbook.log
            data:
              name: "SigEnergy Reason"
              message: "{{ outcome_reason | default('No reason captured') }}"
          - service: input_text.set_value
            target:
              entity_id: !input reason_text_helper
            data:
              value: "{{ outcome_reason | default('No reason captured') | string | truncate(95, True, '') }}"

mode: queued
max: 5
